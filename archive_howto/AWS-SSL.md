# Application of SSL to AWS

이곳에서는 자신이 배포한 웹 서비스에 SSL(Secure Sockets Layer)을 적용시키는 단계를 알아본다.  
(http를 https로 만들겠다는 소리이다.)

사전에 배포된 웹서비스가 있어야 하고 AWS에서 구입하고 적용한 도메인이 있어야 한다.  
([미티어 프로젝트 AWS에 배포하기][미티어프로젝트AWS에배포] 과정을 거쳐왔다는 전제로 서술함)

## How to issue certificate

1. AWS 홈페이지에 접속하여 로그인한다.

1. 상단 좌측 메뉴 `Services > 보안, 자격 증명 및 규정 준수 > Certificate Manager`로 이동

1. 한번도 만든적이 없기 때문에 간단한 소개 페이지가 나오며 하단 좌측에는 `인증서 프로비저닝`, 우측에는 `사설 인증 기관`에
대한 설명을 한다.  
이 문서를 기록하는 시점에는 한국리전의 경우 사설인증을 할 수 없다.  
좌측 **인증서 프로비저닝**의 `시작하기` 클릭!

1. `공인 인증서 요청`을 선택하고 `인증서 요청` 클릭!

1. 입력란에 본인의 도메인을 입력하고 `다음` 클릭!

### DNS 검증

1. `DNS 검증`을 선택하고 `검토` 클릭!

1. 검토 페이지가 나오면 `확인 및 요청` 클릭!

1. **검증** 페이지에서 잠시 후

    |도메인|검증 상태|
    |:---:|:---:|
    |본인이 입력한 도메인|검증 보류|
    
    형태로 결과가 나올것이다. 도메인을 클릭하면 대략 아래와 같은 추가 정보가 나온다.
    
    |이름|유형|값|
    |:---:|:---:|:---:|
    |복잡해보이는 문자열1|CNAME|복잡해보이는 문자열2|
    
    이 값은 매우 중요하므로 기억해두자.  
    `Route 53에서 레코드 생성` 버튼 클릭!
    
1. `Route 53에서 레코드 생성` 팝업창이 뜬다. `생성` 클릭!

1. 잠시후 *DNS 레코드가 Route 53 호스팅 영역에 작성되었습니다. 변경 사항이 전파되고 AWS에서 도메인을 확인할 때까지 30분 정도 걸릴 수 있습니다.*라는
문구가 보인다.  
우측 하단에 `계속` 클릭!

1. 아직은 리스트에 등록한 도메인의 상태가 `검증 보류`일 것이다.  
약 30분 기다리면 되며 중간중간 새로고침을 해야 `발급 완료` 상태를 확인 할 수있다.. (필자는 10분정도 소요되었음)  
72시간 내에 `발급 완료`가 되지 않는 경우 `검증 시간 초과`와 같은 상태가 된다.  
이럴 경우 ACM이 생성한 값으로 DNS 구성을 업데이트하지 않았기 때문으로 이 문제를 해결하려면 새 인증서를 요청해야 한다고 한다.  
(이부분은 경험을 못해봐서 모르겠음...)

## How to apply certificate.

이제 발급받은 인증서를 적용해보도록 하자.  
안타깝게도 인증서를 적용하여 SSL을 활성화 시키려면 ELB(Elastic Load Balancing)라는 서비스를 이용해야 한다.  
이 녀석은 쓰는대로 돈이 나오는 녀석이다... ㅜ

1. AWS 홈페이지 상단 메뉴 `Services > EC2` 이동

1. 좌측 메뉴 `로드 밸런싱 > 로드 밸런서` 이동

1. `로드 밸런서 생성` 클릭!

3가지 종류의 로드 밸런서 중 하나를 선택하라고 한다.  
**Classic Load Balancer(CLB)**가 최초에 나온 서비스 이며 **Application(ALB)** 와 **Network(NLB)** 는
더 세분화되고 기능이 추가되어 나온 서비스 이다.  
기록하는 시점에서는 CLB와 ALB 두 서비스를 이용해서 인증서 적용을 어떻게 하는지 각각 알아볼 것이지만  
둘 중 하나의 방법만 선택해서 진행하면 된다.

### Create CLB (비추천)

1. 3가지 종류의 로드 밸런서 중 하나를 선택하라고 한다.  
안타깝게도 클레식이 가장 비싸다...(왜?)  
**Classic Load Balancer**의 `생성` 버튼 클릭

1. `단계 1: 로드 밸런서 정의` 페이지  
로드 밸런서 이름: `aws-clb-test`  
LB 생성할 VPC: `내 기본 VPC (xxx.xxx.xxx.xxx/xxx)`  
내부 로드 밸런서 생성: `채크 안함`
고급 VPC 구성 활성화: `채크 안함`  
리스너 구성: `HTTP | 80 | HTTP | 80`, `HTTPS | 443 | HTTP | 80`  
우측 하단에 `다음: 보안 그룹 할당` 클릭

1. `단계 2: 보안 그룹 할당` 페이지  
기존 보안 그룹 선택 `채크`  
본인이 서비스 하고 있는 웹이 사용중인 보안그룹 `채크`  
우측 하단 `다음: 보안 설정 구성` 클릭!

1. `단계 3: 보안 설정 구성` 페이지  
인증서 유형: `ACM에서 인증서 선택 (권장)`  
인증서: `방금 만든 인증서`  
사전 정의 보안 정책: `ELBSecurityPolicy-2016-08`  
우측 하단 `다음: 상태 검사 구성` 클릭!

1. `단계 4: 상태 검사 구성` 페이지  
별도 설정 없이 우측 하단 `다음: EC2 인스턴스 추가` 클릭!

1. `단계 5: EC2 인스턴스 추가` 페이지  
본인의 인스턴스 선택 후 우측 하단 `다음: 태그 추가` 클릭!

1. `단계 6: 태그 추가` 페이지  
별도 태그 추가 없이 우측 하단 `검토 및 생성` 클릭!

1. 단계 7: 검토  
입력된 값 확인 후 우측 하단 `생성` 클릭!

1. *성공적으로 로드 밸런서 생성 완료*가 되면 우측에 `닫기` 버튼 클릭!

### Create ALB (추천)

1. 3가지 종류의 로드 밸런서 중 하나를 선택하라고 한다.  
**Application Load Balancer**의 `생성` 버튼 클릭

1. `단계 1: 로드 밸런서 구성` 페이지  
이름: `aws-alb-test`  
체계: `인터넷 연결`  
IP 주소 유형: `ipv4`  
리스너: `HTTP | 80 | HTTP | 80`, `HTTPS | 443 | HTTP | 80`  
가용영역: `VPC: 기본값`, `가용영역: 보이는 리스트 2개 채크`  
우측 하단에 `다음: 보안 설정 구성` 클릭

1. `단계 2: 보안 설정 구성` 페이지  
인증서 유형: `ACM에서 인증서 선택 (권장)`  
인증서 이름: `방금 만든 인증서`  
보안 정책: `ELBSecurityPolicy-2016-08`  
우측 하단 `다음: 보안 그룹 구성` 클릭!

1. `단계 3: 보안 그룹 구성` 페이지  
보안 그룹 할당: `기존 보안 그룹 선택` (본인이 만들어서 사용중인 보안그룹 선택)  
우측 하단 `다음: 라우팅 구성` 클릭!

1. `단계 4: 라우팅 구성` 페이지  
대상 그룹: `새 대상 그룹`  
이름: `aws-alb-route-test`  
대상 유형: `인스턴스`  
프로토콜: `HTTP`  
포트: `80`  
그외 설정은 건드리지 않은 상태로 우측 하단 `다음: 대상 등록` 클릭!

1. `단계 5: 대상 등록` 페이지  
하단 **인스턴스**목록에서 사용할 인스턴스 선택 후 80포트로 `등록된 항목에 추가` 클릭!  
우측 하단 `다음: 검토` 클릭!

1. `단계 6: 검토` 페이지  
입력 정보가 잘못되었는지 확인 후 이상 없으면 우측 하단 `생성` 클릭!

1. *성공적으로 로드 밸런서 생성 완료*가 되면 우측에 `닫기` 버튼 클릭!

### Setting Route 53

1. AWS 홈페이지 상단 매뉴 `Services > 네트워킹 및 콘텐츠 전송 > Route 53` 이동

1. 좌측 매뉴의 `Hosted zones` 클릭!

1. 기존에 배포한 서비스의 도메인(파란색 링크형식)을 클릭!  
도메인을 등록한 적이 없을 경우 좌측 상단 파란색 `Create Hosted Zone` 버튼 클릭! (이후 진행단계는 거의 동일하지만
[미티어 프로젝트 AWS에 배포하기][미티어프로젝트AWS에배포] 과정을 거쳐온 경우를 전제로 서술함)

1. 목록에서 `Name`이 도메인인 열을 선택

1. 우측 세팅값에서 `Alias: Yes` 선택  
`Alias Target: 방금 만든 인증서 선택` (처음에 비어있는 상태이고 클릭하면 선택 리스트가 나올것이다.  
이때 목록 구분중에 **- ELB 000 load balancers -** 바로 아래 방금 만든 인증서가 있다. 000은 *Classic* 또는 *Application*)  
하단의 `Save Record Set` 클릭!

이제 `http://~`나 `https://~`로 나의 웹에 접속이 가능해진다.

## Redirect HTTP to HTTPS

CLB로 인증서를 적용시켰다면 Nginx나 Apache와 같은 것을 사용해야 HTTP 접속자를 HTTPS로 리디렉션 할 수 있다..  
위 소프트웨어를 이용하여 리디렉션 하고 싶을 경우 [이곳][앤진엑스아파치리디렉션방법]을 참고하자.

이곳에서는 ALB로 인증서를 적용시켰다는 가정하에 진행한다. (매우 간단하다)

1. AWS 홈페이지 상단 매뉴 `Services > 로드 밸런싱 > 로드 밸런서` 이동

1. 목록에서 방금 만든 `aws-alb-test`라는 로드 밸러서 선택 후 하단에 `리스너` 탭 클릭

1. 리스너 리스트 중 `HTTP : 80` 줄의 우측 끝에 있는 `규칙 보기/편집` 클릭

1. 이동된 페이지 좌측 상단에 아이콘 중 연필모양의 편집 탭 클릭

1. 그러면 아래 표의 좌측에 연필모양의 아이콘이 생김. 아이콘 클릭

1. 표의 우측에 `1. 다음으로 전달aws-alb-route-test` 과 같이 쓰여있을 것인데 휴지통 아이콘 클릭으로 삭제

1. `작업추가 > 다음으로 리디렉션...` 클릭

1. HTTPS: `443`  
`원본 호스트, 경로, 쿼리`  
`301 - 영구 이동됨`  
하단에 원 안에 v자 모양의 완료 아이콘 클릭

1. 페이지 우측 상단에 `업데이트` 클릭

[미티어프로젝트AWS에배포]:https://github.com/niceplugin/howto/blob/master/meteor-deployment-at-aws.md
[앤진엑스아파치리디렉션방법]:https://aws.amazon.com/ko/premiumsupport/knowledge-center/redirect-http-https-elb/